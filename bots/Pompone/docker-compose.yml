services:
  pompone:
    image: eggdrop:1.9.5
    container_name: pompone
    restart: unless-stopped

    # REQUIRED: Keep stdin open even if not attached
    # Without this, Eggdrop will give "END OF FILE ON TERMINAL" error
    stdin_open: true

    # DCC/Telnet port
    ports:
      - "${DCC_PORT}:2020"

    volumes:
      # Persistent data directory (REQUIRED)
      # Contains: config, userfile, chanfile
      - ./data:/home/eggdrop/eggdrop/data

      # Bot logs (operational logs - mco flags)
      - ./logs/bot:/home/eggdrop/eggdrop/logs/bot

      # Channel logs (for pisg consumption)
      - ./logs/channels:/home/eggdrop/eggdrop/logs/channels

      # Shared TCL scripts (from repo root)
      - ../../shared/tcl-scripts:/home/eggdrop/eggdrop/scripts-shared

    environment:
      - TZ=${TZ}

    networks:
      - pompone-net

  pisg:
    build:
      context: ../../services/pisg
      dockerfile: Dockerfile
    container_name: pompone-pisg
    restart: unless-stopped

    volumes:
      # Channel logs (read-only input)
      - ./logs/channels:/logs:ro

      # PISG cache for faster processing
      - ./pisg-cache:/cache

      # Generated HTML output
      - ./html:/output

      # PISG configuration files
      - ./pisg-config:/config:ro

    environment:
      - CRON_SCHEDULE=${CRON_SCHEDULE}

    networks:
      - pompone-net

    depends_on:
      - pompone

  nginx:
    build:
      context: ../../services/nginx
      dockerfile: Dockerfile
    container_name: pompone-nginx
    restart: unless-stopped

    # HTTP port for stats (configured via .env)
    ports:
      - "${STATS_PORT}:80"

    volumes:
      # Serve the HTML stats generated by pisg
      - ./html:/usr/share/nginx/html:ro

    networks:
      - pompone-net

    depends_on:
      - pisg

networks:
  pompone-net:
    driver: bridge
