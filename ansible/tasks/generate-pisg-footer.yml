---
- name: Find all year directories
  ansible.builtin.find:
    paths: "{{ bot_dir }}/html"
    file_type: directory
    patterns: "[0-9]{4}"
    use_regex: true
    excludes:
      - README.md
  register: year_dirs

- name: Sort year directories
  ansible.builtin.set_fact:
    sorted_years: "{{ year_dirs.files | map(attribute='path') | map('basename') | sort | reverse | list }}"

- name: Generate footer with archive links
  ansible.builtin.template:
    src: templates/pisg-footer.txt.j2
    dest: "{{ bot_dir }}/pisg-config/footer.txt"
    mode: '0644'

- name: Read updated footer content
  ansible.builtin.slurp:
    src: "{{ bot_dir }}/pisg-config/footer.txt"
  register: footer_content

- name: Find all index.html files in year directories
  ansible.builtin.find:
    paths: "{{ bot_dir }}/html"
    patterns: 'index\.html'
    use_regex: true
    recurse: true
  register: year_index_files

- name: Replace archive links block in index.html files
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: '(?s)<!-- BEGIN ARCHIVE LINKS -->.*?<!-- END ARCHIVE LINKS -->'
    replace: |-
      <!-- BEGIN ARCHIVE LINKS -->
      {{ footer_content.content | b64decode | trim }}
      <!-- END ARCHIVE LINKS -->
  loop: "{{ year_index_files.files }}"
  when: year_index_files.matched > 0
